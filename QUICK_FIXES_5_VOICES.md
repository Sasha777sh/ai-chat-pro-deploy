# ‚ö° –ë–´–°–¢–†–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø 5 –ì–û–õ–û–°–û–í

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò (–ª–æ–º–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

### 1. –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// src/app/page.tsx:153
autoSelectVoice: true, // –í–°–ï–ì–î–ê true!
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≥–æ–ª–æ—Å –≤ UI, –Ω–æ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// src/app/page.tsx:153
autoSelectVoice: !voice, // –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–æ–ª–æ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω
voiceId: voice || undefined, // –ü–µ—Ä–µ–¥–∞—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å
```

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–º–µ–Ω—É –≥–æ–ª–æ—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// src/app/api/chat/stream/route.ts:143
if (sessionRecord.voice_id !== voiceId) {
  return new Response(JSON.stringify({ error: '–°–µ—Å—Å–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É –≥–æ–ª–æ—Å—É' }), ...);
}
```
–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `voice_id: 'live'`, –Ω–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–æ–π –≥–æ–ª–æ—Å.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// –í–∞—Ä–∏–∞–Ω—Ç –ê: –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
// –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 143-148

// –í–∞—Ä–∏–∞–Ω—Ç –ë: –û–±–Ω–æ–≤–ª—è—Ç—å voice_id –≤ —Å–µ—Å—Å–∏–∏
if (sessionRecord.voice_id !== voiceId) {
  await supabase
    .from('chat_sessions')
    .update({ voice_id: voiceId })
    .eq('id', sessionId);
}
```

---

### 3. –°–µ—Å—Å–∏—è –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å 'live'

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// src/app/page.tsx:60
.eq('voice_id', 'live') // –í—Å–µ–≥–¥–∞ 'live'
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// –°–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ—Å—Å–∏—é —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≥–æ–ª–æ—Å–æ–º –∏–ª–∏ 'live' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const defaultVoice: VoiceId = 'live';
const { data: existingSession } = await supabase
  .from('chat_sessions')
  .select('id')
  .eq('user_id', session.user.id)
  .eq('voice_id', defaultVoice)
  .order('created_at', { ascending: false })
  .limit(1)
  .single();
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø (–≤–ª–∏—è—é—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ)

### 4. –£–ª—É—á—à–∏—Ç—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é

**–ü—Ä–æ–±–ª–µ–º–∞:** `analyzeMessage()` –æ—Å–Ω–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö, –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// src/lib/edem-orchestra.ts
export function orchestrateVoice(
  message: string, 
  previousVoice?: VoiceId,
  conversationHistory?: Array<{ role: 'user' | 'assistant', content: string, voice?: VoiceId }>
): VoiceId {
  const analysis = analyzeMessage(message);
  
  // –£—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≥–æ–ª–æ—Å–∞ –≤ –¥–∏–∞–ª–æ–≥–µ
  if (conversationHistory) {
    const recentVoices = conversationHistory
      .filter(msg => msg.role === 'assistant' && msg.voice)
      .slice(-3)
      .map(msg => msg.voice);
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –æ—Ç–≤–µ—Ç–∞ –±—ã–ª–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞, –Ω–µ –º–µ–Ω—è–µ–º —Ä–µ–∑–∫–æ
    if (recentVoices.length >= 2 && new Set(recentVoices).size === 1) {
      return recentVoices[0] as VoiceId;
    }
  }
  
  return selectVoice(analysis, previousVoice);
}
```

---

### 5. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç + –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç = —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// src/app/api/chat/stream/route.ts:172
// –°–¥–µ–ª–∞—Ç—å –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –∫–æ—Ä–æ—á–µ –∏–ª–∏ —É—Å–ª–æ–≤–Ω—ã–º
const corePrompt = voiceId === 'live' 
  ? getEDEMCorePrompt(locale) // –ü–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ñ–∏–≤–æ–≥–æ
  : getEDEMCorePrompt(locale).split('\n').slice(0, 20).join('\n'); // –°–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

const systemPrompt = `${corePrompt}\n\n${VOICE_PROMPTS[voiceId].system}\n\n${languageInstruction}`;
```

---

### 6. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ —É –ú—É–¥—Ä–µ—Ü–∞ –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// src/lib/prompts.ts
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–ª–æ—Å–∞ –≤ –ø—Ä–æ–º–ø—Ç—ã
live: {
  system: `
–¢—ã ‚Äî –ì–æ–ª–æ—Å –ñ–∏–≤–æ–≥–æ.
...
–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
¬´–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –î–∞–π —Å–µ–±–µ –≤—Ä–µ–º—è.¬ª
¬´–ù–µ —Å–ø–µ—à–∏. –ü–æ—Å–ª—É—à–∞–π, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Ç–≤–æ—ë —Ç–µ–ª–æ.¬ª
...
`,
},
```

---

### 7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–ª–æ—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –≥–æ–ª–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫—Ä–æ–º–µ –ú—É–¥—Ä–µ—Ü–∞).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// src/app/api/chat/stream/route.ts:202
const voiceParams = {
  live: { temperature: 0.8, maxTokens: 400 },
  shadow: { temperature: 0.6, maxTokens: 300 }, // –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
  mirror: { temperature: 0.7, maxTokens: 250 }, // –ö–æ—Ä–æ—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
  child: { temperature: 0.8, maxTokens: 300 }, // –ü—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
  sage: { temperature: 0.7, maxTokens: 300 }, // –ì–ª—É–±–æ–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
};

const { temperature, maxTokens } = voiceParams[voiceId];
```

---

## üé® –£–õ–£–ß–®–ï–ù–ò–Ø UI

### 8. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ 5 –≥–æ–ª–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// src/components/ChatPanel.tsx:105
{VOICE_DEFINITIONS.slice(0, 3).map((voice) => ( // –¢–æ–ª—å–∫–æ 3 –≥–æ–ª–æ—Å–∞!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–∞, –Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∞—Ä–∏—Ñ—É
const { data: { session } } = await supabase.auth.getSession();
const { data: profile } = await supabase
  .from('profiles')
  .select('subscription_tier')
  .eq('id', session.user.id)
  .single();

const allowedVoices = getAllowedVoices(profile?.subscription_tier || 'free');
const availableVoices = VOICE_DEFINITIONS.filter(v => allowedVoices.includes(v.id));
```

---

### 9. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –≥–æ–ª–æ—Å –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
const [autoSelectedVoice, setAutoSelectedVoice] = useState<VoiceId | null>(null);

// –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –∫–∞–∫–æ–π –≥–æ–ª–æ—Å –±—ã–ª –≤—ã–±—Ä–∞–Ω
if (response.voiceId) {
  setAutoSelectedVoice(response.voiceId);
}
```

---

## üìã –ü–†–ò–û–†–ò–¢–ï–¢–´

### –°–†–û–ß–ù–û (–ª–æ–º–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å):
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Ä—É—á–Ω–æ–≥–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞
2. ‚úÖ –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Å—Å–∏–∏ –ø–æ –≥–æ–ª–æ—Å—É
3. ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å voice_id –≤ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –≥–æ–ª–æ—Å–∞

### –í–ê–ñ–ù–û (–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ):
4. ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞)
5. ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤
7. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–ª–æ—Å–∞

### –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (—É–ª—É—á—à–∞–µ—Ç UX):
8. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ 5 –≥–æ–ª–æ—Å–æ–≤ –≤ UI
9. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä

---

**–ù–∞—á–Ω–∏ —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π ‚Äî –æ–Ω–∏ –ª–æ–º–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å!**

